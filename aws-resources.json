{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Conditions" : {
    "CreateBucket": { "Fn::Equals": [ { "Ref": "pCreateBucket" }, "true" ] }
  },
  "Parameters" : {
    "pCreateBucket": {
      "Description": "Create the bucket true/false [false]",
      "Type": "String",
      "Default": "false"
    }
  },
  "Resources" : {
    "S3Bucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName": "blog-deploy"
      },
      "DeletionPolicy" : "Retain",
      "Condition" : "CreateBucket"
    },
    "SNSTopic" : {
      "Type" : "AWS::SNS::Topic",
      "Properties" : {
      "TopicName": "blog-deploy-committed",
      "Subscription" : [
        {
          "Endpoint" : {"Fn::GetAtt":["DeploymentLambda","Arn"]},
          "Protocol" : "lambda"
        }
      ]}
    },
    "GithubAccessPolicy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "GithubSNSNotificationBlog",
        "PolicyDocument" : {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Action": [
                "sns:Publish"
              ],
              "Sid": "Stmt0000000000000",
              "Resource": [
                {"Fn::Join": ["", ["arn:aws:sns:", {"Ref": "AWS::Region"}, ":", {"Ref": "AWS::AccountId"}, ":blog-deploy-committed"]] }
              ],
              "Effect": "Allow"
            }
          ]
        },
        "Users" : [ "github-sns" ]
      }
    },
    "DeploymentLambda" : {
      "Type" : "AWS::Lambda::Function",
      "Properties" : {
        "Handler": "index.handler",
        "Role" : {"Fn::GetAtt":["DeploymentLambdaRole","Arn"]},
        "Runtime" : "nodejs",
        "Timeout" : 10,
        "Code" : {
          "S3Bucket" : "blog-deploy",
          "S3Key" : "deployment.zip"
        }
      }
    },
    "DeploymentLambdaSNSPermission" : {
      "Type" : "AWS::Lambda::Permission",
      "Properties" : {
        "Action": "lambda:InvokeFunction",
        "FunctionName" : {"Fn::GetAtt":["DeploymentLambda","Arn"]},
        "Principal": "sns.amazonaws.com"
      }
    },
    "DeploymentLambdaRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "AssumeRolePolicyDocument" : {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [ {
          "PolicyName" : "LambdaDeployS3", 
          "PolicyDocument" : {
            "Version" : "2012-10-17",
            "Statement": [ 
              {
                "Effect": "Allow",
                "Resource": "arn:aws:s3:::emil.lerch.org/*",
                "Action": [
                  "s3:*" 
                ]
              },
              {
                "Effect": "Allow",
                "Action": [
                  "logs:CreateLogGroup",
                  "logs:CreateLogStream",
                  "logs:PutLogEvents"
                ],
                "Resource": "arn:aws:logs:*:*:*"
              }
            ]
          }
        } ]
      }
    }
  }
}
